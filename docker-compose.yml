version: '2'
services:
  postgres:
    image: docker.io/postgres:17
    ports:
      - 5433:5433
    volumes:
      - ./docker/sql_setup.sh:/docker-entrypoint-initdb.d/sql_setup.sh
    environment:
      POSTGRES_PASSWORD: postgres
  postgres_replica:
    image: docker.io/postgres:17
    user: postgres
    ports:
      - 5434:5433
    volumes:
      - ./docker/sql_setup_replica.sh:/docker-entrypoint-initdb.d/sql_setup.sh
    environment:
      PGUSER: replicator
      PGPASSWORD: replicator_password
    command: |
      bash -c "
      until pg_basebackup --pgdata=/var/lib/postgresql/data -R --slot=replication_slot -C --host=postgres --port=5433
      do
      echo 'Waiting for primary to connect...'
      sleep 1s
      done
      echo 'Backup done, starting replica...'
      chmod 0700 /var/lib/postgresql/data
      /docker-entrypoint-initdb.d/sql_setup_replica.sh
      postgres
      "
    depends_on:
      - postgres
